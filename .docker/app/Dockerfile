# Stage 1: Build the Nuxt application
FROM node:20-alpine AS builder

# Arbeitsverzeichnis
WORKDIR /app

# Corepack aktivieren (damit pnpm verf체gbar ist)
RUN corepack enable

# Build-Argumente vom CI
ARG NUXT_PUBLIC_SOURCE_COMMIT
ARG NUXT_PUBLIC_ENVIRONMENT

# Ins Environment 체bernehmen, damit Nuxt sie sieht
ENV NUXT_PUBLIC_SOURCE_COMMIT=$NUXT_PUBLIC_SOURCE_COMMIT
ENV NUXT_PUBLIC_ENVIRONMENT=$NUXT_PUBLIC_ENVIRONMENT
ENV NUXT_TELEMETRY_DISABLED=1

# Copy package.json und Lockfile
COPY package.json pnpm-lock.yaml ./

# Installiere Abh채ngigkeiten
RUN pnpm install --frozen-lockfile

# Copy restlicher Code
COPY . .

# Set Build-ENV
ENV NUXT_TELEMETRY_DISABLED=1

# Baue Nuxt-App
RUN pnpm run build

# Stage 2: Production Image
FROM node:20-alpine AS runner

WORKDIR /app

# Corepack aktivieren
RUN corepack enable

# Nur notwendige Dateien 체bernehmen
COPY --from=builder /app/.output ./.output
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml

# Production Dependencies installieren
RUN pnpm install --prod --frozen-lockfile

ENV NUXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production

CMD ["node", ".output/server/index.mjs"]
